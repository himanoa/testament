<!DOCTYPE html>
<html lang="" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>gitをより便利にするsubcommand集を作った &middot; 遺言書</title>
  <meta name="description" content="&lt;p&gt;gitにはsubcommandという仕組みが存在していて、パスが通ったディレクトリに&#43;xなgit-xxxファイルを置いておくと、&lt;code&gt;git xxx&lt;/code&gt; で呼び出せる仕組みが存在します&lt;/p&gt;
&lt;p&gt;具体例を上げると &lt;code&gt;~/bin/&lt;/code&gt; " />
  <meta property="og:type" content="article">
  <meta name="twitter:card" content="summary">
  <meta property="twitter:title" content="gitをより便利にするsubcommand集を作った &middot; 遺言書" >
  <meta property="twitter:description" content="&lt;p&gt;gitにはsubcommandという仕組みが存在していて、パスが通ったディレクトリに&#43;xなgit-xxxファイルを置いておくと、&lt;code&gt;git xxx&lt;/code&gt; で呼び出せる仕組みが存在します&lt;/p&gt;
&lt;p&gt;具体例を上げると &lt;code&gt;~/bin/&lt;/code&gt; " />
  <meta property="twittere:url" content="https://blog.himanoa.net/entries/50/" >
  <meta property="og:image" content="default.jpg">
  <meta property="og:url" content="https://blog.himanoa.net/entries/50/" >
  <meta property="og:title" content="gitをより便利にするsubcommand集を作った &middot; 遺言書" >
  <meta property="og:description" content="&lt;p&gt;gitにはsubcommandという仕組みが存在していて、パスが通ったディレクトリに&#43;xなgit-xxxファイルを置いておくと、&lt;code&gt;git xxx&lt;/code&gt; で呼び出せる仕組みが存在します&lt;/p&gt;
&lt;p&gt;具体例を上げると &lt;code&gt;~/bin/&lt;/code&gt; " />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  
  
  <link href="https://blog.himanoa.net/css/style.min.css" rel="stylesheet">
  <link href="https://blog.himanoa.net/css/xcode.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
  
  
</head>

  <body class="single-body">
    <nav class="nav-bar side-padding">
  <div class="nav-bar-inside">
    <a href="https://blog.himanoa.net" class="nav-large-text">Testament</a>
  </div>
</nav>

    <main class="content side-text-padding">
      <article class="post dropcase">
        <header class="post-header">
        	<h1 class="post-title">gitをより便利にするsubcommand集を作った</h1>
          <p class="post-date">Posted <time datetime="2019-09-10">Sep 10, 2019</time></p>
        </header>
        
        <p>gitにはsubcommandという仕組みが存在していて、パスが通ったディレクトリに+xなgit-xxxファイルを置いておくと、<code>git xxx</code> で呼び出せる仕組みが存在します</p>
<p>具体例を上げると <code>~/bin/</code> にパスが通ってるとして、<code>~/bin/git-wip</code> が存在したなら 任意のgitディレクトリで <code>git wip</code> で <code>~/bin/git-wip</code> が呼び出せます。</p>
<p>さもgitのpluginのような顔をしていますが、別にプラグインだから専用のAPIにアクセスできるみたいなことはありません。</p>
<p>個人的にはgitの操作で結構ワンライナーでかけるけど毎回書くのに気合が必要なやつをラップするコマンドをサブコマンドとして管理すると便利だったりします。</p>
<p>たとえばリポジトリ内でgrepした結果を置換する <code>git grep -l Foo | xargs sed -i '' -e &quot;/Foo/Bar/g&quot;</code> をサブコマンドとして実装するとかです。</p>
<p>やっと本題に戻りますが、これらのサブコマンド集を実装してリポジトリとして公開しました! <a href="https://github.com/himanoa/git-subcommands">himanoa/git-subcommands</a></p>
<h2 id="インストール">インストール</h2>
<p>himanoa/git-subcommands は以下のツールに依存しています。</p>
<ul>
<li>bash</li>
<li>python
<ul>
<li>3.x推奨</li>
</ul>
</li>
<li>git</li>
</ul>
<ol>
<li>git clone <a href="https://github.com/himanoa/git-subcommands">https://github.com/himanoa/git-subcommands</a> ~/git-subcommands</li>
<li>PATHを <code>~/git-subcommands/src</code> に通す</li>
<li>zshとかbashを使っているなら <code>export PATH=~/git-subcommands/src:$PATH</code> とかでいいのでは？</li>
</ol>
<p>インストールが完了したら以下のセクションのサブコマンドがそれぞれ動作できるようになるはずです！</p>
<h2 id="実装したコマンド">実装したコマンド</h2>
<h3 id="git-replace-リポジトリ内の特定の文字列を置換するhttpsgithubcomhimanoagit-subcommandsblobmastersrcgit-strreplace"><a href="https://github.com/himanoa/git-subcommands/blob/master/src/git-strreplace">git-replace リポジトリ内の特定の文字列を置換する</a></h3>
<p>いつも <code>git grep -l Foo | xargs sed -i '' -e &quot;/Foo/Bar/&quot;</code> とか書いてた実装ですね。これをこのサブコマンドを用いることで以下のスニペットまで短縮できます</p>
<pre><code>$ git strreplace Foo Bar
</code></pre><p>ちなみに自慢していたところを<a href="https://twitter.com/unecochan">@unecochan</a>さんに <code>--word-regexp</code> オプションへの対応実装のPRをもらいました！ありがとうございました！</p>
<h3 id="git-base-branch-本流となるブランチを記録するhttpsgithubcomhimanoagit-subcommandsblobmastersrcgit-base-branch"><a href="https://github.com/himanoa/git-subcommands/blob/master/src/git-base-branch">git-base-branch 本流となるブランチを記録する</a></h3>
<p>プロジェクトによって開発者にとって主流になるブランチが違う場合があります。
例えば<a href="https://gist.github.com/Gab-km/3705015">GitHub Flow</a>を採用しているプロジェクトでは master ブランチが本流ですが、
<a href="https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow">Git Flow</a> を採用しているプロジェクトでは develop ブランチが本流に当たります。</p>
<p>開発者が主流になるブランチを常に意識して <code>git checkout</code> コマンドを発行しないといけないのはいささか荷が重いです。</p>
<p>そこで便利な道具なのが <code>git base-branch</code> です</p>
<p><code>git base-branch -a master</code> を実行すればカレントディレクトリに <code>BASE_BRANCH</code> という名前のファイルが追加されます。これは <code>git base-branch</code> が使うファイルです。</p>
<p><code>BASE_BRANCH</code>というファイルが存在する場所で <code>git base-branch</code> コマンドを実行すると先程オプションで指定いた <code>master</code> という文字列が標準出力に出力されます。</p>
<p>これを <code>git checkout</code> コマンドと組み合わせてみましょう！ <code>git checkout $(git base-branch)</code></p>
<p>なんということでしょう。masterブランチに帰還することができました！</p>
<p><code>git base-branch</code> を用いることでどのような開発フローを採用していても人間の記憶領域を侵食する必要がなくなるというわけです！</p>
<h3 id="git-chistory-checkoutしたブランチの履歴を表示するhttpsgithubcomhimanoagit-subcommandsblobmastersrcgit-chistory"><a href="https://github.com/himanoa/git-subcommands/blob/master/src/git-chistory">git-chistory checkoutしたブランチの履歴を表示する</a></h3>
<p>普段仕事をしていると割り込みタスクなどで目まぐるしくブランチを切り替えることがあると思います。</p>
<p>そうなってくると記憶能力が弱い僕は3つ前に作業していたブランチをチェックアウトしたくても名前すら全く思い出せない時があります。</p>
<p>そこで便利なのが <code>git-chistory</code> 、このコマンドを実行すると <code>git reflog</code> からcheckoutのログを抜き出して、移動したブランチのみを抜き出して列挙してくれます！</p>
<p>あとは <code>fzf</code> なり <code>peco</code> に食わせればいいだけなので簡単ですね！</p>
<pre><code>$ git checkout $(git chistory | fzf)
</code></pre><h3 id="git-exec-コマンドを実行し実行したコマンドをコミットメッセージにしてコミットするhttpsgithubcomhimanoagit-subcommandsblobmastersrcgit-exec"><a href="https://github.com/himanoa/git-subcommands/blob/master/src/git-exec">git-exec コマンドを実行し実行したコマンドをコミットメッセージにしてコミットする</a></h3>
<p><code>yarn add --dev @types/react</code> などコマンドを実行した結果起きた副作用をcommitしたい場合があります</p>
<p>僕はそのようなコミットをする時は常に <code>Exec: yarn add --dev @types/react</code> のようなコミットメッセージにしたいのですが、運用でカバーだけでは大変です。</p>
<p>そのような運用をカバーするために作られたのがこのコマンド。引数で実行したいコマンドを渡すことによって、コマンドを実行したあとコミットまでやってくれる便利なツールです</p>
<pre><code>$ git exec &quot;yarn add --dev typescript&quot;
</code></pre><h2 id="使った言語の選定基準">使った言語の選定基準</h2>
<p>リポジトリ見れば一目瞭然なのですが、主に使ったプログラミング言語はPythonでした。</p>
<p>選定理由としては以下の項目を重視した結果です。</p>
<p>他に考えていたプログラミング言語としては <code>Rust</code> <code>TypeScript(Node.js)</code> でした</p>
<ul>
<li>ランタイムがほとんどの環境でデフォルトで入っていること</li>
<li>コマンドライン引数を解析するのに外部ライブラリを必要としないこと</li>
</ul>
<p>とはいえPythonでこのまま書き続けるのは厳しいと判断せざる得ない問題も存在します</p>
<ul>
<li>標準ライブラリのdoctestの出来が微妙</li>
<li>人力で2.xと3.xでのバックポートを意識しながらコードを書くのがつらい
<ul>
<li>今もPython2.xで適切に動くか怪しい</li>
</ul>
</li>
</ul>
<p>とくにdoctestの出来が微妙なのは致命的に僕にとって期待はずれで、Pythonで書かれたコードを全部Rustにリプレースするのを考えています。</p>
<h2 id="おわりに">おわりに</h2>
<p>himanoa/subcommandsはテストもなければ書き方も微妙な単一ファイルのスクリプト集ですが、僕の実務を支える重要なツールになってきています。</p>
<p>こんな粗悪なスクリプト一枚でも実務の効率をぐーんと上げる事ができるので、git周りで不便なワークフローが存在しているならサブコマンドとして実装してみると便利だとと思います。</p>

      </article>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script src="https://blog.himanoa.net/js/core.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  </body>
</html>
